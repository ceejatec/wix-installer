<?xml version='1.0' encoding='windows-1252'?>
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>

  <Product Id="*" Name="Couchbase Server 4.5.0" Version="4.5.0" Manufacturer="Couchbase Inc."
      UpgradeCode="01510917-D2BC-91D4-FD65-4743E498A007"
      Language="1033" Codepage="1252">

    <Package Id="*" Keywords="Installer" Description="Couchbase Server 4.5.0 Installer"
        Comments="Couchbase is a registered trademark of Couchbase Inc."
        Manufacturer="Couchbase Inc."
        Platform="x64"
        InstallerVersion="200" Languages="1033" Compressed="yes" SummaryCodepage="1252"/>

    <Media Id="1" Cabinet="Couchbase.cab" EmbedCab="yes" DiskPrompt="Only file"/>
    <Property Id="DiskPrompt" Value="Couchbase Server 4.5.0 Installation [1]"/>

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder" Name="PFiles">
        <Directory Id="Couchbase" Name="Couchbase">
          <Directory Id="INSTALLDIR" Name="Couchbase Server 4.5.0"/>
          <!-- Contents of this directory generated by heat in Files.wxs -->
        </Directory>
      </Directory>
    </Directory>

    <Feature Id="Complete" Level="1" Title="Couchbase Server" Description="The Complete Package."
        ConfigurableDirectory="INSTALLDIR">
      <ComponentGroupRef Id="CouchbaseServer"/>
    </Feature>

    <!-- Custom action to fix up config files based on installation dir -->
    <CustomAction Id="FixConfigCmd" Property="WixQuietExec64CmdLine" Value="&quot;[SystemFolder]cmd.exe&quot; /c &quot;&quot;[INSTALLDIR]\bin\fixpaths.cmd&quot; &quot;[INSTALLDIR]&quot;&quot;"/>
    <CustomAction Id="FixConfig" BinaryKey="WixCA" DllEntry="WixQuietExec64" Return="check"/>

    <!-- Custom action to register the Erlang service -->
    <CustomAction Id="RegisterServiceCmd" Property="WixQuietExec64CmdLine" Value="&quot;[SystemFolder]cmd.exe&quot; /c &quot;&quot;C:\Fred\bin\service_register.bat&quot;"/>
    <CustomAction Id="RegisterService" BinaryKey="WixCA" DllEntry="WixQuietExec64" Return="check"/>

    <!-- Custom action to unregister the Erlang service -->
    <CustomAction Id="UnregisterServiceCmd" Property="WixQuietExec64CmdLine" Value="&quot;[SystemFolder]cmd.exe&quot; /c &quot;&quot;C:\Fred\bin\service_unregister.bat&quot;"/>
    <CustomAction Id="UnregisterService" BinaryKey="WixCA" DllEntry="WixQuietExec64" Return="check"/>

    <InstallExecuteSequence>
      <!-- All actions to perform on Install, not Uninstall -->

      <!-- Fix Config files -->
      <Custom Action="FixConfigCmd" After="InstallFinalize">NOT Installed</Custom>
      <Custom Action="FixConfig" After="FixConfigCmd">NOT Installed</Custom>

      <!-- Unregister Service - do when REMOVE set, ie. Uninstall or Major Upgrade-->
      <Custom Action="UnregisterServiceCmd" After="FixConfig">REMOVE</Custom>
      <Custom Action="UnregisterService" After="UnregisterServiceCmd">REMOVE</Custom>

      <!-- Register Service - do when not installed, ie. fresh install (QQQ will this work on Major Upgrade?) -->
      <Custom Action="RegisterServiceCmd" After="UnregisterService">NOT Installed</Custom>
      <Custom Action="RegisterService" After="RegisterServiceCmd">NOT Installed</Custom>

    </InstallExecuteSequence>

    <!-- Load in "InstallDir" UI toolkit -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR"/>
    <UIRef Id="WixUI_InstallDir"/>
    <UIRef Id="WixUI_ErrorProgressText"/>

  </Product>
</Wix>
