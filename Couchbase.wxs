<?xml version='1.0' encoding='windows-1252'?>
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>

  <?include $(sys.CURRENTDIR)\Config.wxi?>
  <Product Id="*" Name="$(var.Company) $(var.ProductName)" Version="$(var.Version)" Manufacturer="Couchbase Inc."
      UpgradeCode="01510917-D2BC-91D4-FD65-4743E498A007"
      Language="1033" Codepage="1252">

    <Package Id="*" Keywords="Installer" Description="$(var.Company) $(var.ProductName) $(var.Version) Installer"
        Comments="Couchbase is a registered trademark of Couchbase Inc."
        Manufacturer="Couchbase Inc."
        Platform="x64"
        InstallerVersion="200" Languages="1033" Compressed="yes" SummaryCodepage="1252"/>

    <Media Id="1" Cabinet="Couchbase.cab" EmbedCab="yes" DiskPrompt="Only file"/>
    <Property Id="DiskPrompt" Value="$(var.Company) $(var.ProductName) $(var.Version) Installation [1]"/>

    <MajorUpgrade
        DowngradeErrorMessage="A later version of $(var.Company) $(var.ProductName) is already installed. Setup will now exit."/>

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder" Name="PFiles">
        <Directory Id="$(var.Company)" Name="$(var.Company)">
          <Directory Id="INSTALLDIR" Name="$(var.ProductName)"/>
          <!-- Contents of this directory generated by heat in Files.wxs -->
        </Directory>
      </Directory>
    </Directory>

    <Feature Id="Complete" Level="1" Title="Couchbase Server" Description="The Complete Package."
        ConfigurableDirectory="INSTALLDIR">
      <ComponentGroupRef Id="CouchbaseServer"/>
    </Feature>

    <!-- Custom action to fix up config files based on installation dir -->
    <CustomAction Id="FixConfigCmd" Property="WixQuietExec64CmdLine" Value="&quot;[SystemFolder]cmd.exe&quot; /c &quot;&quot;[INSTALLDIR]\bin\fixpaths.cmd&quot; &quot;[INSTALLDIR]&quot;&quot;"/>
    <CustomAction Id="FixConfig" BinaryKey="WixCA" DllEntry="WixQuietExec64" Return="check"/>

    <!-- Custom action to register the Erlang service -->
    <CustomAction Id="RegisterServiceCmd" Property="WixQuietExec64CmdLine" Value="&quot;[SystemFolder]cmd.exe&quot; /c &quot;&quot;C:\Fred\bin\service_register.bat&quot;"/>
    <CustomAction Id="RegisterService" BinaryKey="WixCA" DllEntry="WixQuietExec64" Return="check"/>

    <!-- Custom action to unregister the Erlang service -->
    <CustomAction Id="UnregisterServiceCmd" Property="WixQuietExec64CmdLine" Value="&quot;[SystemFolder]cmd.exe&quot; /c &quot;&quot;C:\Fred\bin\service_unregister.bat&quot;"/>
    <CustomAction Id="UnregisterService" BinaryKey="WixCA" DllEntry="WixQuietExec64" Return="check"/>

    <InstallExecuteSequence>
      <!-- Unregister Service - do when REMOVE set, ie. Uninstall or Major Upgrade-->
      <Custom Action="UnregisterServiceCmd" Before="UnregisterService">REMOVE</Custom>
      <Custom Action="UnregisterService" Before="InstallValidate">REMOVE</Custom>

      <!-- All actions to perform on Install, not Uninstall -->

      <!-- Fix Config files -->
      <Custom Action="FixConfigCmd" After="InstallFinalize">NOT Installed</Custom>
      <Custom Action="FixConfig" After="FixConfigCmd">NOT Installed</Custom>

      <!-- Register Service - do when not installed, ie. fresh install (QQQ will this work on Major Upgrade?) -->
      <Custom Action="RegisterServiceCmd" After="FixConfig">NOT Installed</Custom>
      <Custom Action="RegisterService" After="RegisterServiceCmd">NOT Installed</Custom>

    </InstallExecuteSequence>

    <!-- Load in "InstallDir" UI toolkit -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR"/>
    <UIRef Id="WixUI_InstallDir"/>
    <UIRef Id="WixUI_ErrorProgressText"/>

  </Product>
</Wix>
