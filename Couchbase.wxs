<?xml version='1.0' encoding='windows-1252'?>
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>

  <?include $(sys.CURRENTDIR)\Config.wxi?>
  <Product Id="*" Name="$(var.Company) $(var.ProductName)" Version="$(var.Version)" Manufacturer="Couchbase Inc."
      UpgradeCode="01510917-D2BC-91D4-FD65-4743E498A007"
      Language="1033" Codepage="1252">

    <Package Id="*" Keywords="Installer" Description="$(var.Company) $(var.ProductName) $(var.Version) Installer"
        Comments="Couchbase is a registered trademark of Couchbase Inc."
        Manufacturer="Couchbase Inc."
        Platform="x64"
        InstallerVersion="405" Languages="1033" Compressed="yes" SummaryCodepage="1252"/>

    <Media Id="1" Cabinet="Couchbase.cab" EmbedCab="yes" DiskPrompt="Only file"/>
    <Property Id="DiskPrompt" Value="$(var.Company) $(var.ProductName) $(var.Version) Installation [1]"/>

    <!-- Search for ucrtbase.dll to identify whether Universal CRT is on target -->
    <Property Id="UCRT32EXISTS">
      <DirectorySearch Id="CheckUcrt32Dir" Path="[SystemFolder]" Depth="0">
        <FileSearch Id="CheckUcrt32" Name="ucrtbase.dll"/>
      </DirectorySearch>
    </Property>
    <Property Id="UCRT64EXISTS">
      <DirectorySearch Id="CheckUcrt64Dir" Path="[System64Folder]" Depth="0">
        <FileSearch Id="CheckUcrt64" Name="ucrtbase.dll"/>
      </DirectorySearch>
    </Property>
    <Condition Message="To install Couchbase Server, the Microsoft Universal C Runtime must be installed. This is delivered by Microsoft via Windows Update. Please ensure your system is up to date. For more detailed installation instructions, see http://bitly.com/2j8mZtT .">UCRT32EXISTS OR UCRT64EXISTS</Condition>

    <!-- Icon for Add/Remove dialog -->
    <Icon Id="icon.ico" SourceFile="$(sys.CURRENTDIR)\assets\couchbase.ico"/>
    <Property Id="ARPPRODUCTICON" Value="icon.ico" />
    <Property Id="ARPURLINFOABOUT" Value="http://www.couchbase.com/"/>

    <!-- Graphics for installer itself -->
    <WixVariable Id="WixUIDialogBmp" Value="$(sys.CURRENTDIR)\assets\cb_installer_bg.jpg"/>

    <MajorUpgrade Schedule="afterInstallExecute"
        DowngradeErrorMessage="A later version of $(var.Company) $(var.ProductName) is already installed. Setup will now exit."/>

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFiles64Folder" Name="PFiles">
        <Directory Id="$(var.Company)" Name="$(var.Company)">
          <Directory Id="INSTALLDIR" Name="$(var.ProductName)"/>
          <!-- Contents of this directory generated by heat in Files.wxs -->
        </Directory>
      </Directory>
      <Merge Id="VCRedist_140" SourceFile="$(env.CommonProgramFiles(x86))\Merge Modules\Microsoft_VC140_CRT_x64.msm" DiskId="1" Language="0"/>
      <Merge Id="VCRedist_120" SourceFile="$(env.CommonProgramFiles(x86))\Merge Modules\Microsoft_VC120_CRT_x64.msm" DiskId="1" Language="0"/>
      <Merge Id="VCRedist_100" SourceFile="$(env.CommonProgramFiles(x86))\Merge Modules\Microsoft_VC100_CRT_x64.msm" DiskId="1" Language="0"/>
    </Directory>

    <Feature Id="Complete" Level="1" Title="Couchbase Server" Description="The Complete Package."
        ConfigurableDirectory="INSTALLDIR">
      <ComponentGroupRef Id="CouchbaseServer"/>
    </Feature>

    <Feature Id="VCRedist" Title="Visual C++ Runtimes" AllowAdvertise="no" Display="hidden" Level="1">
      <MergeRef Id="VCRedist_140"/>
      <MergeRef Id="VCRedist_120"/>
      <MergeRef Id="VCRedist_100"/>
    </Feature>

    <!-- Custom action to fix up config files based on installation dir -->
    <!-- See installer-util.py for explanation of the FOO here -->
    <SetProperty Id="FixConfig" Value="&quot;[INSTALLDIR]bin\installer-util.exe&quot; &quot;[INSTALLDIR]FOO&quot; fixpaths" Before="FixConfig" Sequence="execute"/>
    <CustomAction Id="FixConfig" Execute="deferred" BinaryKey="WixCA" DllEntry="WixQuietExec64" Return="check"/>

    <!-- Custom action to backup var dir -->
    <SetProperty Id="BackupVar" Value="&quot;[INSTALLDIR]bin\installer-util.exe&quot; &quot;[INSTALLDIR]FOO&quot; backup-var" Before="BackupVar" Sequence="execute"/>
    <CustomAction Id="BackupVar" Execute="deferred" BinaryKey="WixCA" DllEntry="WixQuietExec64" Return="check"/>
    <InstallExecuteSequence>
      <!-- Actions to do when REMOVE set, ie. Uninstall or Major Upgrade -->

      <!-- Actions to do on uninstall ONLY (not upgrade, not repair) -->
      <Custom Action="BackupVar" Before="RemoveFiles">REMOVE="ALL" AND NOT UPGRADINGPRODUCTCODE</Custom>

      <!-- Actions to do when not installed, ie. fresh Install or Major Upgrade -->

      <!-- Fix Config files -->
      <Custom Action="FixConfig" After="InstallFiles">NOT Installed</Custom>

    </InstallExecuteSequence>

    <!-- Load in "InstallDir" UI toolkit -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR"/>
    <UIRef Id="WixUI_InstallDir"/>
    <UIRef Id="WixUI_ErrorProgressText"/>

  </Product>
</Wix>
